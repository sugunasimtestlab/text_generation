import streamlit as st
from PIL import Image
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# Streamlit page config
st.set_page_config(page_title="NILA Products Booking", page_icon="ğŸŒ¿")

# âœ… Show banner image correctly
st.image(r"C:\Users\prajin\Desktop\task\image.png", caption="Explore Our Herbal Collection ğŸŒ¿", use_container_width=True)

# âœ… Correct image path handling for products
products = {
    "NILA Herbal Hair Oil 100ml": {
        "price": 199,
        "image": r"C:\Users\prajin\Desktop\task\sample.png"
    },
    "NILA Herbal Hair Pack 50g": {
        "price": 149,
        "image": r"C:\Users\prajin\Desktop\task\sample.png"
    }
}

# --- Product Catalog Preview ---
st.markdown("### ğŸŒ¿ Our Products")
for product_name, details in products.items():
    col1, col2 = st.columns([1, 3])
    with col1:
        st.image(details["image"], use_container_width=True)
    with col2:
        st.markdown(f"**{product_name}**")
        st.markdown(f"ğŸ’¸ â‚¹{details['price']}")
        st.markdown("---")

# --- Product Selection ---
st.markdown("ğŸ›ï¸ Choose your product(s) below and place your order:")
selected_products = st.multiselect("ğŸ§´ Select Product Categories", list(products.keys()))

# Dictionary to store selected product quantities
selected_quantities = {}
total_price = 0

if selected_products:
    st.header("ğŸ§¾ Selected Products & Quantity")
    for product in selected_products:
        col1, col2 = st.columns([2, 1])
        with col1:
            st.image(products[product]["image"], caption=product, use_container_width=True)
        with col2:
            qty = st.number_input(f"Quantity for {product}", min_value=1, max_value=10, step=1, key=product)
            selected_quantities[product] = qty
            total_price += qty * products[product]["price"]

    st.markdown(f"ğŸ’° **Total Price: â‚¹{total_price}**")
else:
    st.info("Please select at least one product category to proceed.")

# --- Order Form ---
st.header("ğŸ“¦ Delivery Details")

name = st.text_input("Full Name")
phone = st.text_input("Phone Number")
email = st.text_input("Email Address (optional)")
address = st.text_area("Delivery Address")

payment_method = st.radio("Payment Method", ["Cash on Delivery", "UPI Payment"])
payment_screenshot = None
if payment_method == "UPI Payment":
    payment_screenshot = st.file_uploader("ğŸ“ Upload UPI Payment Screenshot (JPG/PNG)", type=["jpg", "jpeg", "png"])

st.markdown("ğŸ’³ **UPI ID for Payment:** `sugunasundarajothi@okhdfcbank`")

# --- Email sending function ---
def send_order_email(name, phone, email, address, order_summary, total_price, payment_method):
    sender_email = "sugunasundarajothi@gmail.com"
    sender_password = "your-app-password"  # Replace securely
    receiver_email = "suguna.sundarajothi@outlook.com"

    subject = "New NILA Product Order Received"
    body = f"""
    New order received:

    Name: {name}
    Phone: {phone}
    Email: {email if email else 'N/A'}
    Address: {address}
    Products Ordered:
    {order_summary}

    Total Price: â‚¹{total_price}
    Payment Method: {payment_method}
    """

    message = MIMEMultipart()
    message["From"] = sender_email
    message["To"] = receiver_email
    message["Subject"] = subject
    message.attach(MIMEText(body, "plain"))

    try:
        server = smtplib.SMTP("smtp.gmail.com", 587)
        server.starttls()
        server.login(sender_email, sender_password)
        server.send_message(message)
        server.quit()
    except Exception as e:
        st.error(f"Error sending email: {e}")

# --- Place Order Button ---
if st.button("Place Order"):
    if not selected_products:
        st.error("â— Please select at least one product.")
    elif name and phone and address:
        if payment_method == "UPI Payment" and payment_screenshot is None:
            st.error("â— Please upload a payment screenshot for UPI Payment.")
        else:
            # Generate order summary
            order_summary = ""
            for product, qty in selected_quantities.items():
                price = products[product]["price"]
                subtotal = qty * price
                order_summary += f"{product} x {qty} = â‚¹{subtotal}\n"

            with st.spinner("ğŸ“© Sending your order..."):
                send_order_email(name, phone, email, address, order_summary, total_price, payment_method)

            st.success("âœ… Your order has been placed successfully!")
            st.markdown("### Order Summary:")
            st.text(order_summary)
            st.markdown(f"**Total Price:** â‚¹{total_price}")
            st.markdown(f"**Payment Method:** {payment_method}")
            if payment_screenshot:
                st.image(payment_screenshot, caption="Payment Screenshot", use_container_width=True)
            st.markdown("ğŸ“ We will confirm your order via WhatsApp or call soon.")
    else:
        st.error("â— Please fill all the required fields.")

# Footer
st.markdown("---")
st.markdown("ğŸ“§ Contact us: **suguna.sundarajothi@outlook.com**")
st.markdown("ğŸ“ Location: **Coimbatore, India**")
st.markdown("ğŸ“¸ [Instagram](https://instagram.com/nila_herbal_hairoil)")
st.markdown("ğŸ™‹â€â™€ï¸ [Support](https://instagram.com/queen_of_hills_queenpapa)")
